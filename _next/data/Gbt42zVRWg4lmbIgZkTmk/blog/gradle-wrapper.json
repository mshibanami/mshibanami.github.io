{"pageProps":{"item":{"id":"gradle-wrapper","contentHtml":"<p>Gradleでは基本的にGradleラッパーを介してプログラムが実行される。\nしかしこのラッパーはメモリを20MBほど消費し、CPUにも多少負荷をかけている。\nその為、直接プログラムを実行したい。</p>\n<p><code>build.gradle</code>に下記を書く。</p>\n<div><pre><code class=\"language-groovy\">apply plugin<span>:</span><span>'application'</span>\nmainClassName <span>=</span> <span><span>\"org.gradle.sample.Main\"</span></span>\n</code></pre></div>\n<p><code>org.gradle.sample.Main</code>には、mainメソッドが存在するクラスを指定する。</p>\n<p>そして次のコマンドを実行する。</p>\n<div><pre><code class=\"language-zsh\">% gradle clean installDist</code></pre></div>\n<p>すると<code>build/install/&#x3C;プログラム名>/bin/&#x3C;プログラム名></code> というファイルが作られるのでそれを実行する。</p>\n<p>ここで次のような例外が出た。</p>\n<blockquote>\n<p>Exception in thread \"main\" java.lang.ExceptionInInitializerError\nCaused by: java.lang.NullPointerException</p>\n</blockquote>\n<p>今までrunなどのGradleのタスクから実行していた時には出なかった例外だ。</p>\n<p>例外が発生しているのは以下のコード。</p>\n<div><pre><code class=\"language-java\"><span>URL</span> dirUrl <span>=</span> <span>WordReader</span><span>.</span><span>class</span><span>.</span><span>getClassLoader</span><span>(</span><span>)</span><span>.</span><span>getResource</span><span>(</span><span>\"dir\"</span><span>)</span><span>;</span>\n<span>File</span><span>[</span><span>]</span> langFiles <span>=</span> <span>new</span> <span>File</span><span>(</span>dirUrl<span>.</span><span>getPath</span><span>(</span><span>)</span><span>)</span><span>.</span><span>listFiles</span><span>(</span><span>)</span><span>;</span>\n\n<span>for</span> <span>(</span><span>File</span> f <span>:</span> langFiles<span>)</span> <span>{</span>\n  <span>System</span><span>.</span>out<span>.</span><span>println</span><span>(</span>f<span>.</span><span>getName</span><span>(</span><span>)</span><span>)</span><span>;</span>\n<span>}</span>\n</code></pre></div>\n<p>例外はfor文の書き出しのところで起きている。\nつまりlangPathsがnullとなっている。</p>\n<p>この時、<code>dirUrl</code>は下記のようになっていた。</p>\n<div><pre><code class=\"language-bash\"><span>&#x3C;</span>プロジェクトルート<span>></span>/build/install/<span>&#x3C;</span>プログラム名<span>></span>/lib/<span>&#x3C;</span>プログラム名<span>></span>.jar<span>!</span>/dir\n</code></pre></div>\n<p>つまり、jarファイル内のdirフォルダを読み込むのに失敗している。</p>\n<p><code>gradle run</code>した場合は下記のようになっていた。</p>\n<blockquote>\n<p>&#x3C;プロジェクトルート>/build/resources/main/dir</p>\n</blockquote>\n<p>jarファイル内のファイルを読み込むのは簡単だが、フォルダを読み込むのは難しい。</p>\n<p><a href=\"http://stackoverflow.com/questions/11012819/how-can-i-get-a-resource-folder-from-inside-my-jar-file\">http://stackoverflow.com/questions/11012819/how-can-i-get-a-resource-folder-from-inside-my-jar-file</a></p>\n<p>これをなるべくコードは汚さず、runでもjarからでも動くようにしたい。</p>\n<p>jarの外に、jar内にあるリソースファイルと同じもののシンボリックリンクを作り、それを読み込むことにした。\n冗長だし、libフォルダの中に作ることになるので気持ち悪いが、一番コードを汚さず手軽な方法だと思う。</p>\n<p>まず、</p>\n<div><pre><code class=\"language-java\"><span>URL</span> dirUrl <span>=</span> <span>WordReader</span><span>.</span><span>class</span><span>.</span><span>getClassLoader</span><span>(</span><span>)</span><span>.</span><span>getResource</span><span>(</span><span>\"dir\"</span><span>)</span><span>;</span>\n</code></pre></div>\n<p>としていたところを、</p>\n<div><pre><code class=\"language-java\"><span>URL</span> dirUrl <span>=</span> <span>WordReader</span><span>.</span><span>class</span><span>.</span><span>getClassLoader</span><span>(</span><span>)</span><span>.</span><span>getResource</span><span>(</span><span>\"./dir\"</span><span>)</span><span>;</span>\n</code></pre></div>\n<p>とする。これで、jarからだと、</p>\n<blockquote>\n<p>&#x3C;プロジェクトルート>/build/install/&#x3C;プログラム名>/lib/dir</p>\n</blockquote>\n<p>を読み込もうとし、runからだと前述と変わらないパスを読み込もうとする。</p>\n<p>そして以下のコマンドを実行する。</p>\n<div><pre><code class=\"language-sh\">% ./gradlew clean installDist\n% <span>ln</span> <span>-s</span> <span><span>`</span><span>pwd</span><span>`</span></span>/build/resources/main/* build/install/プログラム名/lib/\n</code></pre></div>\n<p>installDistを実行した時には build/resourcesという、ソースにあるリソースのコピーが作成される。\nその中にある全てのシンボリックリンクをlibフォルダ内に作っている。</p>\n<p>あとは前述の、生成された起動スクリプトを実行すれば動くはず。</p>\n<h2>まとめ</h2>\n<p>メモリをケチってやることでもない。</p>\n","textFormat":0,"sourceFileAbsolutePath":"/home/runner/work/website/website/blog/gradle-wrapper.md","outputPath":"blog/gradle-wrapper","title":"Gradle Wrapperを経由せずに実行する","createdAt":"2016-02-07","language":"ja"}},"__N_SSG":true}